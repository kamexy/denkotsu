# Phase 4: 技能試験対策 実装仕様書

## 概要

- **目的**: 筆記試験合格者が技能試験も突破できるようにサポートする
- **前提**: Phase 3 が完了。合格保証パックの購入者に提供
- **コンテンツ**: ショート動画、複線図練習、欠陥判定クイズ

---

## 4-1. 技能試験の出題形式

毎年1月頃に電気技術者試験センターが **候補問題13問** を公表する。
技能試験当日は、この13問から1問が出題される。

つまり **13問すべてを練習しておけば確実に合格できる。**

### 各候補問題で求められる作業

1. 単線図を複線図に変換する（複線図を描く）
2. ケーブルを適切な長さに切断する
3. ケーブルの被覆を剥ぐ
4. 器具に結線する（ランプレセプタクル、露出型コンセント等）
5. 電線を接続する（リングスリーブ圧着、差込型コネクタ）
6. 完成した回路を確認する

**制限時間: 40分**

---

## 4-2. ショート動画コンテンツ

### コンテンツ構成

```
動画コンテンツ/
├── 基本技術 (8本)
│   ├── ケーブルの切断方法 (30秒)
│   ├── VVFケーブルの被覆剥ぎ (45秒)
│   ├── ランプレセプタクルの結線 (60秒)
│   ├── 露出型コンセントの結線 (60秒)
│   ├── 引掛シーリングの結線 (45秒)
│   ├── リングスリーブ圧着 (45秒)
│   ├── 差込型コネクタの接続 (30秒)
│   └── アウトレットボックスの処理 (45秒)
│
├── 候補問題 施工手順 (13本)
│   ├── No.1 施工手順 (3分)
│   ├── No.2 施工手順 (3分)
│   ├── ...
│   └── No.13 施工手順 (3分)
│
└── 複線図の描き方 (3本)
    ├── 複線図の基本ルール (60秒)
    ├── スイッチ回路の複線図 (60秒)
    └── 3路スイッチの複線図 (90秒)
```

**合計: 24本、総尺約45分**

### 動画の仕様

| 項目 | 仕様 |
|---|---|
| 解像度 | 1080×1920 (縦型、スマホ最適化) |
| フォーマット | MP4 (H.264) |
| ファイルサイズ | 1本あたり5〜15MB |
| 字幕 | 常時表示 (音声なしでも理解可能にする) |
| 再生速度 | 0.5x / 1.0x / 1.5x / 2.0x 切り替え可能 |

### ホスティング

- **Cloudflare R2** に動画を格納
- **Cloudflare Stream** は使わない（月額が発生するため）
- HTML5 `<video>` タグで直接再生
- R2 は転送料0円なので、動画が何回再生されてもコスト増なし

### 動画一覧画面

```
┌──────────────────────────────┐
│  技能試験対策    🔒合格保証    │
│──────────────────────────────│
│                              │
│  ── 基本技術をマスター ──    │
│  ┌──────────────────────┐   │
│  │ ▶ [サムネ] ケーブルの │   │
│  │   切断方法    0:30    │   │  ← 横スクロールカルーセル
│  └──────────────────────┘   │
│  ┌──────────────────────┐   │
│  │ ▶ [サムネ] 被覆剥ぎ  │   │
│  │            0:45      │   │
│  └──────────────────────┘   │
│                              │
│  ── 候補問題 (2026年度) ──   │
│  ┌──────┐┌──────┐┌──────┐ │
│  │ No.1 ││ No.2 ││ No.3 │ │  ← グリッド (3列)
│  │ ✓済  ││      ││      │ │     視聴済みはチェック
│  └──────┘└──────┘└──────┘ │
│  ┌──────┐┌──────┐┌──────┐ │
│  │ No.4 ││ No.5 ││ No.6 │ │
│  └──────┘└──────┘└──────┘ │
│  ...                        │
│                              │
│  ── 複線図の描き方 ──        │
│  ▶ 基本ルール         1:00  │
│  ▶ スイッチ回路       1:00  │
│  ▶ 3路スイッチ        1:30  │
│                              │
└──────────────────────────────┘
```

---

## 4-3. 複線図練習モード

### 仕組み

候補問題の単線図を見て、ステップバイステップで複線図を完成させる対話型練習。

### ステップ式ガイド

```
Step 1/5: 電源の接線を引く

┌──────────────────────────────┐
│                              │
│  [単線図]                    │  ← 候補問題の単線図を表示
│                              │
│  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
│                              │
│  [複線図 (作成中)]           │  ← 段階的に線が追加される
│  ●──────── ... ──────●     │     アニメーションで描画
│                              │
│  💡 白線（接地側）を          │  ← ヒントテキスト
│     すべての負荷に接続します   │
│                              │
│  ┌────────────────────┐    │
│  │   次のステップへ     │    │
│  └────────────────────┘    │
│                              │
└──────────────────────────────┘
```

**ステップの構成 (全候補問題共通):**
1. 電源の接地側（白線）を負荷に接続
2. 電源の非接地側（黒線）をスイッチに接続
3. スイッチから負荷に接続（色指定）
4. 渡り線を接続
5. 完成確認

### 実装方式

- 複線図は **SVG** で描画（Canvas ではなく、DOM操作で段階制御）
- 各ステップで正しい線が追加される（ユーザーがドラッグする必要はない）
- 「次のステップ」ボタンでアニメーション的に線が引かれる
- 全ステップ完了後に完成図を表示

### データ構造

```typescript
interface WiringStep {
  stepNumber: number
  instruction: string          // 「白線を負荷に接続」
  hint: string                 // 「接地側はWで表記」
  svgElements: SVGPathData[]   // このステップで追加するSVG要素
  wireColor: string            // 線の色 ("white" | "black" | "red" | "green")
}

interface CandidateProblem {
  id: number                   // 1〜13
  year: number                 // 2026
  singleLineDiagram: string    // 単線図の画像パス
  steps: WiringStep[]          // 複線図作成ステップ
  completedDiagram: string     // 完成図の画像パス
}
```

---

## 4-4. 欠陥判定クイズ

### 仕組み

完成した施工の写真を見て、「合格」か「不合格（欠陥あり）」かを判定するクイズ。

### 画面

```
┌──────────────────────────────┐
│  欠陥判定クイズ               │
│──────────────────────────────│
│                              │
│  ┌──────────────────────┐   │
│  │                       │   │
│  │  [施工写真]            │   │  ← 拡大可能（ピンチズーム）
│  │  (リングスリーブ圧着   │   │
│  │   部分のクローズアップ) │   │
│  │                       │   │
│  └──────────────────────┘   │
│                              │
│  Q. この施工は合格？          │
│                              │
│  ┌────────┐ ┌────────┐     │
│  │  合格  │ │ 欠陥あり│     │
│  └────────┘ └────────┘     │
│                              │
└──────────────────────────────┘
```

### 正誤フィードバック

```
┌──────────────────────────────┐
│                              │
│  ✗ 不正解！ 欠陥があります   │
│                              │
│  [施工写真 + 欠陥箇所にマーカー]│
│                              │
│  💡 欠陥内容:                │
│  リングスリーブの圧着マークが │
│  「小」であるべき箇所が       │
│  「中」になっている。          │
│                              │
│  📌 判定基準:                │
│  VVF1.6mm 2本 → 小スリーブ   │
│  VVF1.6mm 3本 → 小スリーブ   │
│  VVF2.0mm含む → 中スリーブ   │
│                              │
└──────────────────────────────┘
```

### 欠陥の種類 (出題対象)

| カテゴリ | 欠陥例 | 問題数 |
|---|---|---|
| 圧着不良 | スリーブサイズ違い、圧着マーク違い、心線の露出 | 8問 |
| 結線不良 | 極性間違い、接続忘れ、被覆の噛み込み | 8問 |
| 寸法不良 | ケーブル長さ不足、被覆剥き過ぎ | 4問 |
| その他 | 正しい施工（合格） | 10問 |
| **合計** | | **30問** |

### データ構造

```typescript
interface DefectQuestion {
  id: string
  image: string                    // 施工写真パス
  hasDefect: boolean               // true: 欠陥あり, false: 合格
  defectType?: string              // 欠陥の種類
  defectDescription?: string       // 欠陥の説明
  defectMarkerPosition?: {         // 欠陥箇所のマーカー位置 (%)
    x: number
    y: number
    width: number
    height: number
  }
  judgingCriteria: string           // 判定基準の解説
}
```

---

## 4-5. 技能試験タイムライン機能

### 仕様

試験当日の40分の使い方をシミュレーションするタイマー。

```
┌──────────────────────────────┐
│  タイムライン練習  No.1       │
│──────────────────────────────│
│                              │
│  残り: 38:24                  │
│  ████████████████░░░░░░░░░   │
│                              │
│  現在のフェーズ:              │
│  ② ケーブル加工 (目安: 15分)  │
│                              │
│  ┌──────────────────────┐   │
│  │ ① 複線図作成    5分  │ ✓ │
│  │ ② ケーブル加工  15分 │ ← │  ← 現在
│  │ ③ 器具への結線  10分 │   │
│  │ ④ 電線の接続    5分  │   │
│  │ ⑤ 見直し・修正  5分  │   │
│  └──────────────────────┘   │
│                              │
│  ┌──────┐  ┌──────┐       │
│  │一時停止│  │リセット│       │
│  └──────┘  └──────┘       │
│                              │
└──────────────────────────────┘
```

**機能:**
- 40分のカウントダウンタイマー
- 各フェーズの目安時間を表示
- フェーズ切り替えは手動（「次のフェーズ」ボタン）
- 残り5分でアラート通知
- 終了後に各フェーズの実績時間を表示

---

## 画面構成の変更

### BottomNav の更新

```
Phase 3: 📊 学習    🏠 ホーム    🎁 図鑑    ⚙ 設定
Phase 4: 📊 学習    🏠 ホーム    🎁 図鑑    🔧 技能    ⚙ 設定
```

5タブに変更。「技能」タブで技能試験対策コンテンツを表示。
ただし合格保証パック未購入者には「技能」タブはロック表示。

---

## コンテンツの年次更新

技能試験の候補問題は毎年1月に更新される可能性がある。

### 更新フロー

```
毎年1月:
  1. 電気技術者試験センターが候補問題を公表
  2. 前年と差分を確認 (通常1〜3問が入れ替わる)
  3. 新問題の複線図データ・動画を作成
  4. 旧問題を「過去の候補問題」として保持 (削除しない)
  5. アプリを更新デプロイ
```

### データ管理

```
src/data/
├── practical/
│   ├── 2026/
│   │   ├── candidates.json      # 候補問題メタデータ
│   │   ├── wiring-steps/        # 複線図ステップデータ
│   │   │   ├── no1.json
│   │   │   ├── no2.json
│   │   │   └── ...
│   │   └── defects.json         # 欠陥判定クイズデータ
│   └── 2025/                    # 過去年度も保持
│       └── ...
```

---

## 完了条件

1. **動画**: 基本技術8本 + 候補問題13本 + 複線図3本 = 24本が再生できる
2. **複線図練習**: 13問すべてでステップ式ガイドが動作する
3. **欠陥判定**: 30問のクイズが動作し、写真上に欠陥箇所がマーキングされる
4. **タイムライン**: 40分タイマーが正しく動作する
5. **アクセス制御**: 合格保証パック購入者のみ閲覧可能
6. **ストレージ**: 動画がCloudflare R2から配信され、再生に問題がない
