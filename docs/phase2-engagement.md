# Phase 2: エンゲージメント強化 実装仕様書

## 概要

- **目的**: リテンション（継続率）を高める仕組みを追加し、「また開きたい」を作る
- **前提**: Phase 1 が完了し、Cloudflare Pages で公開済み
- **方針**: ログインなし（アカウント不要）で、同期コードベースの軽量同期を採用する
- **追加技術**: Cloudflare D1 + Workers（同期API）, IndexedDB, Framer Motion

---

## 2-1. クラウド同期（ログインなし）

### 仕様

- **同期方式**: 同期コード（12〜64文字）を使った手動同期
- **認証方式**: OAuth/アカウント認証は採用しない
- **基本操作**:
  - この端末の学習データをクラウドへ保存（push）
  - クラウドの学習データをこの端末へ復元（pull）
- **同期待機方式**: オフライン時はローカル優先、オンライン復帰時に手動実行

### 画面フロー（設定 > データ > クラウド同期）

```
[目的を選択]
  ├── バックアップを作る
  └── バックアップを復元

[STEP 1: 同期コードを準備]
  - 新しいコードを作る（推奨）
  - 既存コードを入力
  - このコードを保存

[STEP 2: 実行]
  ├── バックアップを実行（push）
  └── 復元を実行（pull）

[結果表示]
  - 最終同期時刻
  - 成功/失敗メッセージ
```

### 同期アーキテクチャ

```
ブラウザ (IndexedDB)          Cloudflare D1
┌──────────────┐             ┌──────────────────┐
│ answers      │ ──push──→  │ sync_snapshots   │
│ spacedRep    │ ──push──→  │ payload_json      │
│ settings     │ ──push──→  │ updated_at        │
└──────────────┘             └──────────────────┘
       ↑                              │
       └────────── pull ──────────────┘
```

### コンフリクト解決

```
ルール: Last-Write-Wins（updated_at ベース）

- push時に clientUpdatedAt < serverUpdatedAt の場合は上書きしない
- stale として応答し、ユーザーは pull で最新を取得できる
```

### API エンドポイント（実装済み仕様）

- `POST /api/sync/push`
  - Body: `{ syncId, clientUpdatedAt, snapshot }`
  - Response: `{ success, applied, serverUpdatedAt, reason? }`
- `GET /api/sync/pull?syncId=...`
  - Response: `{ success, hasSnapshot, serverUpdatedAt, snapshot? }`
- `GET /healthz`

### 同期コードのセキュリティ要件

- 12〜64文字
- 使用可能文字: 英数字 / `-` / `_`
- 英字と数字を両方含む
- 連番、同一文字連続、推測容易語（`123456`, `password` など）は拒否

---

## 2-2. SM-2 忘却曲線アルゴリズム

Phase 1 の簡易復習ロジックを、SM-2ベースの定着重視ロジックへ更新する。

### 実装方針

- 正解/不正解に加えて、回答時間から quality（0〜5）を算出
- `easeFactor`, `intervalDays`, `nextReviewAt` を更新
- 出題優先度は以下順で判定
  1. `nextReviewAt` 超過問題
  2. 未回答問題
  3. 定着度の低い問題（intervalが短い順）

### 制約

- 直近10問で同一カテゴリが3問以上連続しない
- 直近5問の同一問題再出題を避ける

---

## 2-3. コレクション機能

### 仕様

- 正解時にのみドロップ判定
- ドロップ率: 30%
- レアリティ:
  - ノーマル: 70%
  - レア: 25%
  - レジェンド: 5%

### 体験

- 正解後に「NEWアイテム」トースト表示
- 図鑑画面で収集率を可視化
- 各アイテムに豆知識を付与し、学習コンテンツとして機能させる

---

## 2-4. 実績（アチーブメント）システム

### 仕様

- 実績数: 15
- 判定タイミング: 回答後に都度判定
- 新規解除時: トースト通知 + サウンド
- 一度解除した実績は再通知しない

### 代表実績

- はじめの一歩（初回回答）
- 10問達成 / 50問達成 / 100問達成
- 5連続正解 / 10連続正解
- 分野別マスター
- 全分野制覇 / 合格圏内

---

## 2-5. 追加の出題形式

### 対象

- ◯✕クイズ（true/false）
- 画像タップ（image_tap）

### 方針

- 既存4択を壊さない形で Question 型を拡張
- 解説表示・統計計算・合格力計算は既存導線に統合

---

## 2-6. 問題数の拡充

Phase 2 完了時点で **600問** を目標とする。

| 分野 | Phase 1 | Phase 2 追加 | 合計 |
|---|---|---|---|
| 電気理論 | 17問 | 83問 | 100問 |
| 配線図 | 17問 | 103問 | 120問 |
| 法規 | 17問 | 79問 | 96問 |
| 工事方法 | 17問 | 103問 | 120問 |
| 器具・材料 | 16問 | 80問 | 96問 |
| 検査・測定 | 16問 | 52問 | 68問 |
| **合計** | **100問** | **500問** | **600問** |

---

## 画面構成の変更

### BottomNav の更新

```
Phase 1: クイズ / 要点 / 成績 / 設定
Phase 2: クイズ / 要点 / 成績 / 図鑑 / 設定
```

「図鑑」タブでコレクションと実績を統合表示する。

---

## 完了条件

1. **同期**: 同期コード方式で2端末間の push/pull が動作する
2. **忘却曲線**: 復習問題の再出題タイミングが改善される
3. **コレクション**: 正解時にドロップし、図鑑で確認できる（50個）
4. **実績**: 条件達成時に通知され、一覧で確認できる（15個）
5. **出題形式**: 4択に加え、◯✕と画像タップが動作する
6. **問題数**: 600問以上が収録される
